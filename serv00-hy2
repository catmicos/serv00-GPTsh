#!/bin/bash

# 介绍信息
{
    echo -e "\e[92m"
    echo "通往电脑的路不止一条，所有的信息都应该是免费的，打破电脑特权，在电脑上创造艺术和美，计算机将使生活更美好。"
    echo -e "\e[0m"
}

# 获取当前用户名和工作目录
USER=$(whoami)
USER_HOME=$(readlink -f /home/$USER)
HYSTERIA_WORKDIR="$USER_HOME/.hysteria"

# 创建必要的目录
mkdir -p "$HYSTERIA_WORKDIR"

# 获取最新 Hysteria 版本的下载链接
get_latest_hysteria_url() {
    curl -s https://api.github.com/repos/apernet/hysteria/releases/latest | grep "browser_download_url.*hysteria-linux-" | cut -d '"' -f 4
}

# 下载最新的 Hysteria 2
download_latest_hysteria() {
    ARCH=$(uname -m)
    if [[ "$ARCH" == "x86_64" || "$ARCH" == "amd64" ]]; then
        FILE_URL=$(get_latest_hysteria_url | grep "amd64")
    elif [[ "$ARCH" == "arm64" || "$ARCH" == "aarch64" ]]; then
        FILE_URL=$(get_latest_hysteria_url | grep "arm64")
    else
        echo "不支持的架构: $ARCH"
        exit 1
    fi
    
    FILENAME="$HYSTERIA_WORKDIR/hysteria"
    if [[ -e "$FILENAME" ]]; then
        echo -e "\e[1;32mHysteria 已存在，检查更新...\e[0m"
        LOCAL_VERSION=$("$FILENAME" -version 2>/dev/null || echo "unknown")
        echo "当前版本: $LOCAL_VERSION"
    else
        echo -e "\e[1;32m正在下载最新的 Hysteria...\e[0m"
        curl -L -sS -o "$FILENAME" "$FILE_URL"
        chmod +x "$FILENAME"
        echo -e "\e[1;32m下载完成\e[0m"
    fi
}

# 随机生成密码
generate_password() {
  export PASSWORD=${PASSWORD:-$(uuidgen)}
}

# 设置服务器端口
set_server_port() {
  read -p "请输入 hysteria2 端口 (默认 20026): " input_port
  export SERVER_PORT="${input_port:-20026}"
}

# 生成证书
generate_cert() {
  openssl req -x509 -nodes -newkey ec:<(openssl ecparam -name prime256v1) -keyout "$HYSTERIA_WORKDIR/server.key" -out "$HYSTERIA_WORKDIR/server.crt" -subj "/CN=bing.com" -days 36500
}

# 生成配置文件
generate_config() {
  cat << EOF > "$HYSTERIA_WORKDIR/config.yaml"
listen: :$SERVER_PORT

tls:
  cert: $HYSTERIA_WORKDIR/server.crt
  key: $HYSTERIA_WORKDIR/server.key

auth:
  type: password
  password: "$PASSWORD"

fastOpen: true

masquerade:
  type: proxy
  proxy:
    url: https://bing.com
    rewriteHost: true

transport:
  udp:
    hopInterval: 30s
EOF
}

# 运行 Hysteria 2
run_hysteria() {
  if [[ -e "$HYSTERIA_WORKDIR/hysteria" ]]; then
    nohup "$HYSTERIA_WORKDIR/hysteria" server --config "$HYSTERIA_WORKDIR/config.yaml" >/dev/null 2>&1 &
    sleep 1
    echo -e "\e[1;32mHysteria 2 正在运行\e[0m"
  else
    echo -e "\e[1;31mHysteria 2 未找到，请检查下载是否成功\e[0m"
  fi
}

# 获取IP地址
get_ip() {
  ipv4=$(curl -s 4.ipw.cn)
  if [[ -n "$ipv4" ]]; then
    HOST_IP="$ipv4"
  else
    ipv6=$(curl -s --max-time 1 6.ipw.cn)
    if [[ -n "$ipv6" ]]; then
      HOST_IP="$ipv6"
    else
      echo -e "\e[1;35m无法获取IPv4或IPv6地址\033[0m"
      exit 1
    fi
  fi
  echo -e "\e[1;32m本机IP: $HOST_IP\033[0m"
}

# 获取网络信息
get_ipinfo() {
  ISP=$(curl -s https://speed.cloudflare.com/meta | awk -F\" '{print $26"-"$18}' | sed -e 's/ /_/g')
}

# 输出配置
print_config() {
  echo -e "\e[1;32mHysteria2 安装成功\033[0m"
  echo ""
  echo -e "\e[1;33mV2rayN或Nekobox 配置\033[0m"
  echo -e "\e[1;32mhysteria2://$PASSWORD@$HOST_IP:$SERVER_PORT/?sni=www.bing.com&alpn=h3&insecure=1#$ISP\033[0m"
  echo ""
  echo -e "\e[1;33mSurge 配置\033[0m"
  echo -e "\e[1;32m$ISP = hysteria2, $HOST_IP, $SERVER_PORT, password = $PASSWORD, skip-cert-verify=true, sni=www.bing.com\033[0m"
  echo ""
  echo -e "\e[1;33mClash 配置\033[0m"
  cat << EOF
- name: $ISP
  type: hysteria2
  server: $HOST_IP
  port: $SERVER_PORT
  password: $PASSWORD
  alpn:
    - h3
  sni: www.bing.com
  skip-cert-verify: true
  fast-open: true
EOF
}

# 安装 Hysteria
install_hysteria() {
  download_latest_hysteria
  generate_password
  set_server_port
  generate_cert
  generate_config
  run_hysteria
  get_ip
  get_ipinfo
  print_config
}

# 主程序
read -p "是否安装 Hysteria 2？(Y/N 回车N): " install_hysteria_answer
install_hysteria_answer=${install_hysteria_answer^^}

if [[ "$install_hysteria_answer" == "Y" ]]; then
  install_hysteria
fi
