#!/bin/bash



# 获取当前用户名和主目录
USER=$(whoami)
USER_HOME=$(getent passwd "$USER" | cut -d: -f6)
HYSTERIA_WORKDIR="$USER_HOME/.hysteria"

# 创建必要的目录
mkdir -p "$HYSTERIA_WORKDIR"

# 随机生成密码
generate_password() {
  PASSWORD=$(uuidgen)
}

# 设置服务器端口
set_server_port() {
  read -p "请输入 hysteria2 端口 (默认 20026): " input_port
  SERVER_PORT="${input_port:-20026}"
}

# 下载最新的 Hysteria
download_latest_hysteria() {
  echo "正在下载最新的 Hysteria..."
  ARCH=$(uname -m)
  
  if [[ "$ARCH" == "arm" || "$ARCH" == "arm64" || "$ARCH" == "aarch64" ]]; then
    URL="https://download.hysteria.network/app/latest/hysteria-freebsd-arm64"
  elif [[ "$ARCH" == "amd64" || "$ARCH" == "x86_64" ]]; then
    URL="https://download.hysteria.network/app/latest/hysteria-freebsd-amd64"
  else
    echo "不支持的架构: $ARCH"
    exit 1
  fi

  curl -L -sS -o "$HYSTERIA_WORKDIR/hysteria" "$URL"
  if [[ $? -ne 0 ]]; then
    echo "Hysteria 下载失败，请检查网络或 URL。"
    exit 1
  fi
  
  chmod +x "$HYSTERIA_WORKDIR/hysteria"
  echo "下载完成"
}

# 生成配置文件
generate_config() {
  cat << EOF > "$HYSTERIA_WORKDIR/config.yaml"
listen: :$SERVER_PORT

tls:
  cert: $HYSTERIA_WORKDIR/server.crt
  key: $HYSTERIA_WORKDIR/server.key

auth:
  type: password
  password: "$PASSWORD"

fastOpen: true

masquerade:
  type: proxy
  proxy:
    url: https://bing.com
    rewriteHost: true

transport:
  udp:
    hopInterval: 30s
EOF
}

# 运行 Hysteria
run_hysteria() {
  nohup "$HYSTERIA_WORKDIR/hysteria" server "$HYSTERIA_WORKDIR/config.yaml" >/dev/null 2>&1 &
  sleep 1
  echo "Hysteria 正在运行"
}

# 获取本机 IP 地址
get_ip() {
  HOST_IP=$(curl -s 4.ipw.cn)
  if [[ -z "$HOST_IP" ]]; then
    echo "无法获取IPv4地址"
    exit 1
  fi
  echo "本机IP: $HOST_IP"
}

# 输出配置
print_config() {
  echo "Hysteria2 安装成功"
  echo "V2rayN或Nekobox 配置"
  echo "hysteria2://$PASSWORD@$HOST_IP:$SERVER_PORT/?sni=www.bing.com&alpn=h3&insecure=1"
}

# 安装 Hysteria
install_hysteria() {
  generate_password
  set_server_port
  download_latest_hysteria
  generate_config
  run_hysteria
  get_ip
  print_config
}

# 主程序
read -p "是否安装 Hysteria 2？(Y/N 回车N): " install_hysteria_answer
install_hysteria_answer=${install_hysteria_answer^^}

if [[ "$install_hysteria_answer" == "Y" ]]; then
  install_hysteria
else
  echo "安装被取消。"
fi
